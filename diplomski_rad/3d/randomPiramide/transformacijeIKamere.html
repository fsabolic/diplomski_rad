<!--SOURCE: https://webgpufundamentals.org/webgpu/lessons/webgpu-cameras.html-->
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>Eksplozija</title>
    <meta name="description" content="" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="style.css" />
    <script src="varijable.js"></script>
    <script src="skripte/vec3.js"></script>
    <script src="skripte/mat4.js"></script>
    <script src="skripte/definirajCesticu.js"></script>
    <script src="skripte/kreirajBuffere.js"></script>
    <script src="skripte/odrediWorkgroupBroj.js"></script>
    <script src="skripte/postaviWebGPU.js"></script>
    <script src="skripte/postaviMatricu3DTransformacija.js"></script>
    <script src="skripte/cookies.js"></script>
    <script src="skripte/simulatorKomande.js"></script>
    <script src="shaderi/renderShaderi/cesticeRenderShaderiWGSL.js"></script>
    <script src="shaderi/renderShaderi/cesticeRenderShader.js"></script>
    <script src="shaderi/computeShaderi/computeShaderiWGSL.js"></script>
    <script src="shaderi/computeShaderi/sileComputeShader.js"></script>
    <script src="shaderi/computeShaderi/prngComputeShader.js"></script>
    <script src="shaderi/renderShaderi/gridRenderShader.js"></script>
    <script type="module">
      function postaviParametre() {
        uniCompParamsViews.dt.set([postavke.dt]);
        uniCompParamsViews.otpor.set([postavke.otpor]);
        uniCompParamsViews.gravitacija.set([postavke.gravitacija]);
        uniCompParamsViews.pozicijaEksplozije.set([
          postavke.pozicijaEksplozije.x,
          postavke.pozicijaEksplozije.y,
          postavke.pozicijaEksplozije.z,
        ]);
        device.queue.writeBuffer(uniCompParamsBuffer, 0, uniCompParamsValues);

        postavke.incr += 0.07;
        uniRenderParamsViews.iteracija.set([postavke.incr]);

        device.queue.writeBuffer(
          uniRenderParamsBuffer,
          0,
          uniRenderParamsValues
        );
      }

      function postaviCanvasObserver() {
        const observer = new ResizeObserver((entries) => {
          for (const entry of entries) {
            const canvas = entry.target;
            const width = entry.contentBoxSize[0].inlineSize;
            const height = entry.contentBoxSize[0].blockSize;
            canvas.width = Math.max(
              1,
              Math.min(width, device.limits.maxTextureDimension2D)
            );
            canvas.height = Math.max(
              1,
              Math.min(height, device.limits.maxTextureDimension2D)
            );

            render();
          }
        });
        observer.observe(canvas);
      }

      function postaviPostavke() {
        let cookiePostavke = dohvatiPostavkeCookie();
        if (cookiePostavke) {
          if (cookiePostavke.reset) {
            postavke = cookiePostavke;
          }
          document.getElementById("gravity").value = postavke.gravitacija;
          document.getElementById("resistance").value = postavke.otpor;
          document.getElementById("dt").value = postavke.dt * 2000;
          document.getElementById("number-of-particles").value =
            postavke.brojCesticaXWG / brojWG;

          document.getElementById("grid").checked = postavke.grid;
          document.getElementById("explosion-position-x").value =
            postavke.pozicijaEksplozije.x;
          document.getElementById("explosion-position-y").value =
            postavke.pozicijaEksplozije.y;
          document.getElementById("explosion-position-z").value =
            postavke.pozicijaEksplozije.z;
        }
      }

      function render() {
        if (!postavke.pauza) {
          postaviMatricu3DTransformacija();
          postaviParametre();
          izvrsiSileComputeShader();
          izvrsiCesticeRenderShader();
          if (postavke.grid) izvrsiGridRenderShader();
        }
        requestAnimationFrame(render);
      }

      async function main() {
        await postaviWebGPU();
        postaviPostavke();
        kreirajBuffere();
        kreirajCesticeRenderShader();
        kreirajGridRenderShader();
        kreirajPRNGComputeShader();
        postaviParametre();
        izvrsiPRNGComputeShader();
        kreirajSileComputeShader();
        postavke.reset = false;
        postaviPostavkeCookie();
        postaviCanvasObserver();
      }

      function fail(msg) {
        alert(msg);
      }

      main();
    </script>
  </head>
  <body>
    <div class="console-container">
      <button id="close" type="button" onclick="zatvori(event)">-</button>
      <div id="console" class="console" style="opacity: 100">
        <div class="console-button-container">
          <button id="start" type="button" onclick="pokreni()">
            <img src="./assets/play.png" />
          </button>
          <button id="stop" type="button" onclick="pauziraj()">
            <img src="./assets/pause.png" />
          </button>
          <button id="restart" type="button" onclick="reset()">
            <img src="./assets/restart.png" />
          </button>
          <button id="reload" type="button" onclick="reload()">
            <img src="./assets/reload.png" />
          </button>
        </div>
        <div class="console-inputs-container">
          <div class="console-input">
            <label class="input-label">Grid</label>
            <input
              id="grid"
              class="input-input"
              type="checkbox"
              id="grid"
              oninput="grid()"
            />
          </div>
          <div class="console-input">
            <label class="input-label">dt</label>
            <input
              id="dt"
              class="input-input"
              type="range"
              min="0"
              max="120"
              value="60"
              id="dt-slider"
              oninput="dt(value)"
            />
          </div>
          <div class="console-input">
            <label class="input-label">Br. ƒç.</label>
            <input
              id="number-of-particles"
              class="input-input"
              type="text"
              oninput="brCestica(value)"
              value="25"
            />
          </div>
          <div class="console-input">
            <label class="input-label">Grav.</label>
            <input
              id="gravity"
              class="input-input"
              type="text"
              oninput="gravitacija(value)"
            />
          </div>
          <div class="console-input">
            <label class="input-label">Otpor</label>
            <input
              id="resistance"
              class="input-input"
              type="text"
              oninput="otpor(value)"
            />
          </div>
        </div>
        <div class="console-coordinates-table">
          <table class="coordinates-table">
            <thead>
              <tr class="coordinates-header-row">
                <th class="coordinates-header-cell"></th>
                <th class="coordinates-header-cell">x</th>
                <th class="coordinates-header-cell">y</th>
                <th class="coordinates-header-cell">z</th>
              </tr>
            </thead>
            <tbody>
              <tr class="coordinates-row">
                <td class="coordinates-cell">
                  <img width="25px" height="20px" src="./assets/bomb.svg" />
                </td>
                <td class="coordinates-cell">
                  <input
                    id="explosion-position-x"
                    class="coordinates-input"
                    type="text"
                    oninput="explosionPositionX(event)"
                  />
                </td>
                <td class="coordinates-cell">
                  <input
                    class="coordinates-input"
                    type="text"
                    id="explosion-position-y"
                    oninput="explosionPositionY(event)"
                  />
                </td>
                <td class="coordinates-cell">
                  <input
                    class="coordinates-input"
                    type="text"
                    id="explosion-position-z"
                    oninput="explosionPositionZ(event)"
                  />
                </td>
              </tr>
              <tr class="coordinates-row">
                <td class="coordinates-cell">
                  <img width="25px" height="20px" src="./assets/object.svg" />
                </td>
                <td class="coordinates-cell">
                  <input class="coordinates-input" type="text" />
                </td>
                <td class="coordinates-cell">
                  <input class="coordinates-input" type="text" />
                </td>
                <td class="coordinates-cell">
                  <input class="coordinates-input" type="text" />
                </td>
              </tr>
              <tr class="coordinates-row">
                <td class="coordinates-cell">
                  <img width="25px" height="20px" src="./assets/camera.svg" />
                </td>
                <td class="coordinates-cell">
                  <input class="coordinates-input" type="text" />
                </td>
                <td class="coordinates-cell">
                  <input class="coordinates-input" type="text" />
                </td>
                <td class="coordinates-cell">
                  <input class="coordinates-input" type="text" />
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    <canvas></canvas>
  </body>
</html>
