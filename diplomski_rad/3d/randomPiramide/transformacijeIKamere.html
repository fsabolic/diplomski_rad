<!--SOURCE: https://webgpufundamentals.org/webgpu/lessons/webgpu-cameras.html-->
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>Eksplozija</title>
    <meta name="description" content="" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="style.css" />
    <script src="varijable.js"></script>
    <script src="skripte/vec3.js"></script>
    <script src="skripte/mat4.js"></script>
    <script src="skripte/definirajCesticu.js"></script>
    <script src="skripte/kreirajBuffere.js"></script>
    <script src="skripte/odrediWorkgroupBroj.js"></script>
    <script src="skripte/postaviWebGPU.js"></script>
    <script src="skripte/postaviMatricu3DTransformacija.js"></script>
    <script src="shaderi/renderShaderi/cesticeRenderShaderiWGSL.js"></script>
    <script src="shaderi/renderShaderi/cesticeRenderShader.js"></script>
    <script src="shaderi/computeShaderi/computeShaderiWGSL.js"></script>
    <script src="shaderi/computeShaderi/sileComputeShader.js"></script>
    <script src="shaderi/computeShaderi/prngComputeShader.js"></script>
    <script type="module">
      import GUI from "https://webgpufundamentals.org/3rdparty/muigui-0.x.module.js";
      function postaviGUI(render) {
        const gui = new GUI();
        gui.onChange(render);
        gui.add(postavke, "dt");
        gui.add(postavke, "otpor", { min: 0, max: 5 });
        gui.add(postavke, "gravitacija", { min: 0, max: 1000 });
        gui.addButton("pokreni", (_) => (postavke.dt = 0.01667));
        gui.addButton("pauziraj", (_) => (postavke.dt = 0));
      }

      function postaviParametre() {
        uniCompParamsViews.dt.set([postavke.dt]);
        uniCompParamsViews.otpor.set([postavke.otpor]);
        uniCompParamsViews.gravitacija.set([postavke.gravitacija]);
        postavke.incr += 0.07;
        uniRenderParamsViews.iteracija.set([postavke.incr]);
        device.queue.writeBuffer(uniCompParamsBuffer, 0, uniCompParamsValues);
      }

      function render() {
        postaviParametre();
        postaviMatricu3DTransformacija();
        izvrsiSileComputeShader();
        izvrsiCesticeRenderShader();
        requestAnimationFrame(render);
      }

      function postaviCanvasObserver() {
        //OVO TREBA OBRISAT
        const observer = new ResizeObserver((entries) => {
          for (const entry of entries) {
            const canvas = entry.target;
            const width = entry.contentBoxSize[0].inlineSize;
            const height = entry.contentBoxSize[0].blockSize;
            canvas.width = Math.max(
              1,
              Math.min(width, device.limits.maxTextureDimension2D)
            );
            canvas.height = Math.max(
              1,
              Math.min(height, device.limits.maxTextureDimension2D)
            );

            render();
          }
        });
        observer.observe(canvas);
      }

      async function main() {
        await postaviWebGPU();
        kreirajBuffere();
        kreirajCesticeRenderShader();
        postaviGUI(render);
        postaviCanvasObserver();
        kreirajPRNGComputeShader();
        postaviParametre();
        izvrsiPRNGComputeShader();
        kreirajSileComputeShader();
      }

      function fail(msg) {
        alert(msg);
      }

      main();
    </script>
  </head>
  <body>
    <canvas></canvas>
  </body>
</html>
