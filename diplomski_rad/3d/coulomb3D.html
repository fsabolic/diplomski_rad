<!--SOURCE: https://webgpufundamentals.org/webgpu/lessons/webgpu-cameras.html-->
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>3D - Coulomb jednostruka eksplozija</title>
    <meta name="description" content="" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="style.css" />
    <script src="varijable.js"></script>
    <script src="skripte/vec3.js"></script>
    <script src="skripte/mat4.js"></script>
    <script src="skripte/definirajCesticu.js"></script>
    <script src="skripte/kreirajBuffere.js"></script>
    <script src="skripte/odrediWorkgroupBroj.js"></script>
    <script src="skripte/postaviWebGPU.js"></script>
    <script src="skripte/postaviMatricu3DTransformacija.js"></script>
    <script src="skripte/localStorage.js"></script>
    <script src="skripte/simulatorKomande.js"></script>
    <script src="shaderi/renderShaderi/cesticeRenderShaderiWGSL.js"></script>
    <script src="shaderi/renderShaderi/cesticeRenderShader.js"></script>
    <script src="shaderi/computeShaderi/computeShaderiWGSL.js"></script>
    <script src="shaderi/computeShaderi/sileComputeShader.js"></script>
    <script src="shaderi/computeShaderi/prngComputeShader.js"></script>
    <script src="shaderi/renderShaderi/gridRenderShader.js"></script>
    <script type="module">
      function postaviParametre() {
        uniCompParamsViews.dt.set([postavke.dt]);
        uniCompParamsViews.otpor.set([postavke.otpor]);
        uniCompParamsViews.gravitacija.set([postavke.gravitacija]);
        uniCompParamsViews.pozicijaEksplozije.set([
          postavke.pozicijaEksplozije.x,
          postavke.pozicijaEksplozije.y,
          postavke.pozicijaEksplozije.z,
        ]);
        uniCompParamsViews.snagaPotencijala.set([postavke.snagaPotencijala]);
        uniCompParamsViews.radijusCestica.set([postavke.radijusCestica]);
        device.queue.writeBuffer(uniCompParamsBuffer, 0, uniCompParamsValues);

        postavke.incr += 0.07;
        uniRenderParamsViews.iteracija.set([postavke.incr]);

        device.queue.writeBuffer(
          uniRenderParamsBuffer,
          0,
          uniRenderParamsValues
        );
        document.getElementById("object-position-x").value =
          postavke.pozicijaObjekta.x;
        document.getElementById("object-position-y").value =
          postavke.pozicijaObjekta.y;
        document.getElementById("object-position-z").value =
          postavke.pozicijaObjekta.z;
        document.getElementById("camera-position-x").value =
          postavke.pozicijaKamere.x;
        document.getElementById("camera-position-y").value =
          postavke.pozicijaKamere.y;
        document.getElementById("camera-position-z").value =
          postavke.pozicijaKamere.z;
      }

      function postaviCanvasObserver() {
        const observer = new ResizeObserver((entries) => {
          for (const entry of entries) {
            const canvas = entry.target;
            const width = entry.contentBoxSize[0].inlineSize;
            const height = entry.contentBoxSize[0].blockSize;
            canvas.width = Math.max(
              1,
              Math.min(width, device.limits.maxTextureDimension2D)
            );
            canvas.height = Math.max(
              1,
              Math.min(height, device.limits.maxTextureDimension2D)
            );
            render();
          }
        });
        observer.observe(canvas);
      }

      function postaviPostavke() {
        let localStoragePostavke = dohvatiPostavkeLocalStorage();
        if (localStoragePostavke) {
          if (localStoragePostavke.reset) {
            postavke = localStoragePostavke;
          }
        }
        document.getElementById("gravity").value = postavke.gravitacija;
        document.getElementById("resistance").value = postavke.otpor;
        document.getElementById("dt").value = postavke.dt;
        document.getElementById("number-of-particles").value =
          postavke.brojCesticaXWG / brojWG;

        document.getElementById("grid").checked = postavke.grid;
        document.getElementById("explosion-position-x").value =
          postavke.pozicijaEksplozije.x;
        document.getElementById("explosion-position-y").value =
          postavke.pozicijaEksplozije.y;
        document.getElementById("explosion-position-z").value =
          postavke.pozicijaEksplozije.z;
        document.getElementById("potential-strength").value =
          postavke.snagaPotencijala;
        document.getElementById("potential-particle-radius").value =
          postavke.radijusCestica;
        document.getElementById("object-position-x").value =
          postavke.pozicijaObjekta.x;
        document.getElementById("object-position-y").value =
          postavke.pozicijaObjekta.y;
        document.getElementById("object-position-z").value =
          postavke.pozicijaObjekta.z;
        document.getElementById("camera-position-x").value =
          postavke.pozicijaKamere.x;
        document.getElementById("camera-position-y").value =
          postavke.pozicijaKamere.y;
        document.getElementById("camera-position-z").value =
          postavke.pozicijaKamere.z;
      }

      let iframe = 0;
      let starttime = Date.now() / 1000;
      function render() {
        let framerate = (iframe++ / (Date.now() / 1000 - starttime)).toFixed(3);
        document.getElementById("fps-counter").innerHTML = framerate;
        if (!postavke.pauza) {
          postaviMatricu3DTransformacija();
          postaviParametre();
          izvrsiSileComputeShader();
          izvrsiCesticeRenderShader();
          if (postavke.grid) izvrsiGridRenderShader();
        }
      }

      function simulacija() {
        render();
        requestAnimationFrame(simulacija);
      }

      async function main() {
        await postaviWebGPU();
        postaviPostavke();
        kreirajBuffere();
        kreirajPRNGComputeShader();
        kreirajCesticeRenderShader();
        kreirajSileComputeShader();
        kreirajGridRenderShader();
        postaviParametre();
        izvrsiPRNGComputeShader();
        postavke.reset = false;
        postaviPostavkeLocalStorage();
        dodajEventListenere();
        postaviCanvasObserver();
        simulacija();
      }

      main();
    </script>
  </head>
  <body>
    <div class="stats-display">
      <div class="fps">
        <p id="fps-counter">123.2</p>
        <p>&nbsp;FPS</p>
      </div>
      <div class="logger">
        <p id="keys-logger">Pritisnite W</p>
      </div>
    </div>
    <div class="console-container">
      <button id="close" type="button" onclick="zatvori(event)">-</button>
      <div id="console" class="console" style="opacity: 100">
        <div class="console-button-container">
          <button id="start" type="button" onclick="pokreni()">
            <img src="./assets/play.png" />
          </button>
          <button id="stop" type="button" onclick="pauziraj()">
            <img src="./assets/pause.png" />
          </button>
          <button id="restart" type="button" onclick="reset()">
            <img src="./assets/restart.png" />
          </button>
          <button id="reload" type="button" onclick="reload()">
            <img src="./assets/reload.png" />
          </button>
        </div>
        <div class="console-inputs-container">
          <div class="console-input">
            <label class="input-label">Grid</label>
            <input
              id="grid"
              class="input-input"
              type="checkbox"
              id="grid"
              oninput="grid()"
            />
          </div>
          <div class="console-input">
            <label class="input-label">Korak (dt)</label>
            <input
              id="dt"
              class="input-input"
              type="text"
              oninput="dt(value)"
            />
          </div>
          <div class="console-input">
            <label class="input-label">Br. čestica (*256)</label>
            <input
              id="number-of-particles"
              class="input-input"
              type="text"
              oninput="brCestica(value)"
              value="25"
            />
          </div>
          <div class="console-input">
            <label class="input-label">Silina eksplozije</label>
            <input
              id="potential-strength"
              class="input-input"
              type="text"
              oninput="potentialStrength(value)"
            />
          </div>
          <div class="console-input">
            <label class="input-label">Polumjer čestica</label>
            <input
              id="potential-particle-radius"
              class="input-input"
              type="text"
              oninput="particleRadius(value)"
            />
          </div>
          <div class="console-input">
            <label class="input-label">Sila teža</label>
            <input
              id="gravity"
              class="input-input"
              type="text"
              oninput="gravitacija(value)"
            />
          </div>
          <div class="console-input">
            <label class="input-label">Otpor sredstva</label>
            <input
              id="resistance"
              class="input-input"
              type="text"
              oninput="otpor(value)"
            />
          </div>
        </div>
        <div class="console-coordinates-table">
          <table class="coordinates-table">
            <thead>
              <tr class="coordinates-header-row">
                <th class="coordinates-header-cell"></th>
                <th class="coordinates-header-cell">x</th>
                <th class="coordinates-header-cell">y</th>
                <th class="coordinates-header-cell">z</th>
              </tr>
            </thead>
            <tbody>
              <tr class="coordinates-row">
                <td class="coordinates-cell">
                  <img width="25px" height="20px" src="./assets/bomb.svg" />
                </td>
                <td class="coordinates-cell">
                  <input
                    id="explosion-position-x"
                    class="coordinates-input"
                    type="text"
                    oninput="explosionPositionX(event)"
                  />
                </td>
                <td class="coordinates-cell">
                  <input
                    class="coordinates-input"
                    type="text"
                    id="explosion-position-y"
                    oninput="explosionPositionY(event)"
                  />
                </td>
                <td class="coordinates-cell">
                  <input
                    class="coordinates-input"
                    type="text"
                    id="explosion-position-z"
                    oninput="explosionPositionZ(event)"
                  />
                </td>
              </tr>
              <tr class="coordinates-row">
                <td class="coordinates-cell">
                  <img width="25px" height="20px" src="./assets/object.svg" />
                </td>
                <td class="coordinates-cell">
                  <input
                    class="coordinates-input"
                    type="text"
                    id="object-position-x"
                    oninput="objectPositionX(event)"
                  />
                </td>
                <td class="coordinates-cell">
                  <input
                    class="coordinates-input"
                    type="text"
                    id="object-position-y"
                    oninput="objectPositionY(event)"
                  />
                </td>
                <td class="coordinates-cell">
                  <input
                    class="coordinates-input"
                    type="text"
                    id="object-position-z"
                    oninput="objectPositionZ(event)"
                  />
                </td>
              </tr>
              <tr class="coordinates-row">
                <td class="coordinates-cell">
                  <img width="25px" height="20px" src="./assets/camera.svg" />
                </td>
                <td class="coordinates-cell">
                  <input
                    class="coordinates-input"
                    type="text"
                    id="camera-position-x"
                    oninput="cameraPositionX(event)"
                  />
                </td>
                <td class="coordinates-cell">
                  <input
                    class="coordinates-input"
                    type="text"
                    id="camera-position-y"
                    oninput="cameraPositionY(event)"
                  />
                </td>
                <td class="coordinates-cell">
                  <input
                    class="coordinates-input"
                    type="text"
                    id="camera-position-z"
                    oninput="cameraPositionZ(event)"
                  />
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    <canvas></canvas>
  </body>
</html>
